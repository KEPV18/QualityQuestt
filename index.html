<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
		<script src="https://unpkg.com/unlazy@0.11.3/dist/unlazy.with-hashing.iife.js" defer init></script>
		<script type="text/javascript">
			window.tailwind.config = {
				darkMode: ['class'],
				theme: {
					extend: {
						colors: {
							border: 'hsl(var(--border))',
							input: 'hsl(var(--input))',
							ring: 'hsl(var(--ring))',
							background: 'hsl(var(--background))',
							foreground: 'hsl(var(--foreground))',
							primary: {
								DEFAULT: 'hsl(var(--primary))',
								foreground: 'hsl(var(--primary-foreground))'
							},
							secondary: {
								DEFAULT: 'hsl(var(--secondary))',
								foreground: 'hsl(var(--secondary-foreground))'
							},
							destructive: {
								DEFAULT: 'hsl(var(--destructive))',
								foreground: 'hsl(var(--destructive-foreground))'
							},
							muted: {
								DEFAULT: 'hsl(var(--muted))',
								foreground: 'hsl(var(--muted-foreground))'
							},
							accent: {
								DEFAULT: 'hsl(var(--accent))',
								foreground: 'hsl(var(--accent-foreground))'
							},
							popover: {
								DEFAULT: 'hsl(var(--popover))',
								foreground: 'hsl(var(--popover-foreground))'
							},
							card: {
								DEFAULT: 'hsl(var(--card))',
								foreground: 'hsl(var(--card-foreground))'
							},
						},
					}
				}
			}
		</script>
		<style type="text/tailwindcss">
			@layer base {
				:root {
					--background: 0 0% 100%;
--foreground: 240 10% 3.9%;
--card: 0 0% 100%;
--card-foreground: 240 10% 3.9%;
--popover: 0 0% 100%;
--popover-foreground: 240 10% 3.9%;
--primary: 240 5.9% 10%;
--primary-foreground: 0 0% 98%;
--secondary: 240 4.8% 95.9%;
--secondary-foreground: 240 5.9% 10%;
--muted: 240 4.8% 95.9%;
--muted-foreground: 240 3.8% 46.1%;
--accent: 240 4.8% 95.9%;
--accent-foreground: 240 5.9% 10%;
--destructive: 0 84.2% 60.2%;
--destructive-foreground: 0 0% 98%;
--border: 240 5.9% 90%;
--input: 240 5.9% 90%;
--ring: 240 5.9% 10%;
--radius: 0.5rem;
				}
				.dark {
					--background: 240 10% 3.9%;
--foreground: 0 0% 98%;
--card: 240 10% 3.9%;
--card-foreground: 0 0% 98%;
--popover: 240 10% 3.9%;
--popover-foreground: 0 0% 98%;
--primary: 0 0% 98%;
--primary-foreground: 240 5.9% 10%;
--secondary: 240 3.7% 15.9%;
--secondary-foreground: 0 0% 98%;
--muted: 240 3.7% 15.9%;
--muted-foreground: 240 5% 64.9%;
--accent: 240 3.7% 15.9%;
--accent-foreground: 0 0% 98%;
--destructive: 0 62.8% 30.6%;
--destructive-foreground: 0 0% 98%;
--border: 240 3.7% 15.9%;
--input: 240 3.7% 15.9%;
--ring: 240 4.9% 83.9%;
				}
			}
            img, video {
    max-width: 10%;
}

flex justify-between items-center py-4 border-b border-border {   padding-left: 20px;
    

}
		</style>
        
  </head>
  <body>
    <div class="bg-background text-foreground min-h-screen p-4 space-y-6">
      <h1 class="text-4xl font-bold text-center">QualityQuest</h1>
      <p class="text-center text-sm text-muted-foreground">by Ahmed Khaled</p>
  
  <div class="flex justify-between items-center py-4 border-b border-border">
    <div class="flex items-center space-x-4">
      <img src="360_F_518939699_8Zco4PagLxKxIFzWj7zYiZD6xSE9Ynb5.jpg" alt="Company Logo" class="rounded-full">
      <nav class="space-x-4">
        <a href="#" class="text-primary hover:underline" id="home-tab">Home</a>
        <a href="#" class="text-primary hover:underline" id="settings-tab">Settings</a>
        <a href="#" class="text-primary hover:underline" id="help-tab">Help</a>
        <a href="#" class="text-primary hover:underline" id="all-data-tab">All Data</a>
      </nav>
    </div>
    <div class="flex items-center space-x-4">
      <button class="bg-secondary text-secondary-foreground p-2 rounded-full">ğŸ””</button>
    </div>
  </div>
  
  <div id="team-selection" class="bg-card p-4 rounded-lg shadow">
    <h2 class="text-xl font-bold mb-4">Select Your Team</h2>
    <div id="team-options" class="space-y-2">
      <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ -->
    </div>
  </div>
  
  <div id="team-details" class="hidden bg-card p-4 rounded-lg shadow">
    <h2 id="team-name" class="text-xl font-bold mb-2"></h2>
    <p id="team-composition" class="text-muted-foreground mb-4"></p>
    <table class="w-full text-left">
      <thead>
        <tr class="border-b border-border">
          <th class="py-2">Device Number</th>
          <th class="py-2">Email</th>
          <th class="py-2">Member Name</th>
          <th class="py-2">Tasks Completed</th>
          <th class="py-2">Quality Rating</th>
          <th class="py-2">Last Task</th>
        </tr>
      </thead>
      <tbody id="member-details">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
      </tbody>
    </table>
    <div class="mt-4">
      <p id="total-tasks" class="text-lg font-semibold"></p>
      <p id="overall-quality" class="text-lg font-semibold"></p>
    </div>
  </div>
  
  <div class="bg-card p-4 rounded-lg shadow">
    <h2 class="text-xl font-bold mb-4">Team Rankings</h2>
    <ul id="team-rankings" class="space-y-2">
      
    </ul>
  </div>

</div>

<script>
  const apiKey = 'AIzaSyDctNVWQhbsQMEDfJDXI30emaTd8mtviEY';
  const sheetId = '1EbKvgMRzVKucfGuIOUqJbfncI194MNGJO-9ZVmIJnIw';
  const worksheetName = 'tracking(M)';

  async function fetchTeams() {
    try {
      const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${worksheetName}?key=${apiKey}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();
      const rows = data.values;

      // Extract unique team names from column B (index 1)
      const teamNames = [...new Set(rows.map(row => row[1]))].filter(name => name);

      console.log('Team names:', teamNames); // Debugging: Check team names

      return teamNames;
    } catch (error) {
      console.error('Error fetching team names:', error);
      return [];
    }
  }

  async function fetchLastTask(email) {
    try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Form!B:D?key=${apiKey}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const rows = data.values;

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        const userRows = rows.filter(row => row[1] === email); // Ø§Ù„Ø¹Ù…ÙˆØ¯ B (index 1)

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙÙˆÙØŒ Ù†Ø£Ø®Ø° Ø¢Ø®Ø± ØµÙ ÙˆÙ†Ø±Ø¬Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ D (index 3)
        if (userRows.length > 0) {
            return userRows[userRows.length - 1][3]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ D (index 3)
        }
        return ''; // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØµÙÙˆÙ
    } catch (error) {
        console.error('Error fetching last task:', error);
        return '';
    }
  }

  async function fetchTeamData(teamName) {
    try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${worksheetName}?key=${apiKey}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const rows = data.values;

        // Filter rows based on the selected team from column B (index 1)
        const teamMembers = await Promise.all(rows.filter(row => row[1] === teamName).map(async row => {
            const email = row[2]; // Ø§Ù„Ø¹Ù…ÙˆØ¯ C (index 2)
            const lastTask = await fetchLastTask(email); // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø±Ø§Ø¨Ø· Ù…Ù† ÙˆØ±Ù‚Ø© Form
            return {
                deviceNumber: row[0], // Ø§Ù„Ø¹Ù…ÙˆØ¯ A (index 0)
                email: email,
                memberName: row[5], // Ø§Ù„Ø¹Ù…ÙˆØ¯ F (index 5)
                tasks: parseInt(row[13]) || 0, // Ø§Ù„Ø¹Ù…ÙˆØ¯ N (index 13)
                quality: row[12], // Ø§Ù„Ø¹Ù…ÙˆØ¯ M (index 12)
                lastTask: lastTask // Ø¢Ø®Ø± Ø±Ø§Ø¨Ø·
            };
        }));

        console.log('Filtered team members:', teamMembers); // Debugging: Check filtered data

        return teamMembers;
    } catch (error) {
        console.error('Error fetching data:', error);
        return [];
    }
  }

  async function initializeTeamSelection() {
    const teamOptions = document.getElementById('team-options');
    const teamNames = await fetchTeams();

    if (teamNames.length === 0) {
      teamOptions.innerHTML = '<p class="text-red-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±Ù‚ Ù…ØªØ§Ø­Ø©.</p>';
      return;
    }

    teamOptions.innerHTML = teamNames.map(name => `
      <label class="flex items-center space-x-2 cursor-pointer">
        <input type="radio" name="team" value="${name}" class="form-radio text-primary">
        <span>${name}</span>
      </label>
    `).join('');

    document.querySelectorAll('input[name="team"]').forEach(radio => {
      radio.addEventListener('change', async (event) => {
        const selectedTeam = event.target.value;
        const teamData = await fetchTeamData(selectedTeam);
        const memberDetails = document.getElementById('member-details');
        const totalTasks = document.getElementById('total-tasks');
        const overallQuality = document.getElementById('overall-quality');
        const teamDetails = document.getElementById('team-details');
        const noTeamMessage = document.getElementById('no-team-message');

        // Clear previous messages
        noTeamMessage.textContent = '';

        if (teamData.length === 0) {
          // If no team members found, show a message
          noTeamMessage.textContent = `Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±ÙŠÙ‚ Ø¨Ø§Ù„Ø§Ø³Ù… "${selectedTeam}"`;
          teamDetails.classList.add('hidden');
          return;
        }

        memberDetails.innerHTML = teamData.map(member => `
          <tr class="border-b border-border hover:bg-secondary transition">
            <td class="py-2">${member.deviceNumber}</td>
            <td class="py-2">${member.email}</td>
            <td class="py-2">${member.memberName}</td>
            <td class="py-2">${member.tasks}</td>
            <td class="py-2">${member.quality}</td>
            <td class="py-2">${member.lastTask}</td>
          </tr>
        `).join('');

        totalTasks.textContent = `Total Tasks Completed: ${teamData.reduce((sum, member) => sum + member.tasks, 0)}`;
        overallQuality.textContent = `Overall Quality Rating: ${teamData.reduce((sum, member) => sum + parseFloat(member.quality), 0) / teamData.length}%`;
        teamDetails.classList.remove('hidden');
      });
    });
  }

  async function fetchAllData() {
    try {
      const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${worksheetName}?key=${apiKey}`);
      if (!response.ok) {
        if (response.status === 404) {
          throw new Error('Sheet not found. Please check the sheet ID.');
        } else if (response.status === 403) {
          throw new Error('Access denied. Please check your API key permissions.');
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      }
      const data = await response.json();
      const rows = data.values;

      console.log('All data fetched:', rows); // Debugging: Check all data

      return rows;
    } catch (error) {
      console.error('Error fetching all data:', error);
      return { error: error.message };
    }
  }

  async function initializeAllDataTab() {
    const allDataDetails = document.getElementById('all-data-details');
    const errorMessage = document.getElementById('error-message');
    const allData = await fetchAllData();

    if (allData.error) {
      errorMessage.textContent = allData.error;
      allDataDetails.innerHTML = '';
      return;
    }

    if (allData.length === 0) {
      allDataDetails.innerHTML = '<tr><td colspan="5" class="text-red-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©.</td></tr>';
      return;
    }

    allDataDetails.innerHTML = allData.map(row => `
      <tr class="border-b border-border hover:bg-secondary transition">
        ${row.map(cell => `<td class="py-2">${cell}</td>`).join('')}
      </tr>
    `).join('');
  }

  document.getElementById('all-data-tab').addEventListener('click', (event) => {
    event.preventDefault();
    document.getElementById('all-data').classList.remove('hidden');
    initializeAllDataTab();
  });

  async function updateTeamRankings() {
    const teamRankings = document.getElementById('team-rankings');
    const teamNames = await fetchTeams(); // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ÙØ±Ù‚
    const allData = await fetchAllData(); // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆÙƒÙˆØ§Ù„ØªÙŠ Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚
    const rankings = teamNames.map(teamName => {
      const teamMembers = allData.filter(row => row[1] === teamName); // Ø§Ù„Ø¹Ù…ÙˆØ¯ B (index 1)
      const totalTasks = teamMembers.reduce((sum, member) => sum + (parseInt(member[13]) || 0), 0); // Ø§Ù„Ø¹Ù…ÙˆØ¯ N (index 13)
      const overallQuality = teamMembers.length > 0 ? (teamMembers.reduce((sum, member) => sum + parseFloat(member[12]), 0) / teamMembers.length) : 0; // Ø§Ù„Ø¹Ù…ÙˆØ¯ M (index 12)
      return { teamName, totalTasks, overallQuality };
    });

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    teamRankings.innerHTML = rankings.map(ranking => `
      <li class="border-b border-border py-2">
        <span class="font-semibold">${ranking.teamName}</span>: 
        Total Tasks: ${ranking.totalTasks}, 
        Overall Quality: ${ranking.overallQuality.toFixed(2)}%
      </li>
    `).join('');
  }

  // Call the updateTeamRankings function after initializing team selection
  window.onload = async () => {
    await initializeTeamSelection();
    await updateTeamRankings(); // ØªØ­Ø¯ÙŠØ« ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„ÙØ±Ù‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  };
</script>

<div id="no-team-message" class="text-red-500"></div>

  </body>
</html>